name: Docker Image Sync

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'æºé•œåƒå (å¦‚ elasticsearch)'
        required: true
        default: 'elasticsearch'
      image_tag:
        description: 'é•œåƒç‰ˆæœ¬å· (å¦‚ 7.4.2)'
        required: true
        default: '7.4.2'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Login to Aliyun
        run: |
          # è‡ªåŠ¨ä¿®å‰ª Registry å˜é‡ä¸­çš„ç©ºæ ¼å’Œæ–œæ 
          REGISTRY=$(echo "${{ secrets.ALIYUN_REGISTRY }}" | sed 's|^https://||;s|/*$||;s| ||g')
          echo "${{ secrets.ALIYUN_PASSWORD }}" | docker login --username=${{ secrets.ALIYUN_USERNAME }} --password-stdin $REGISTRY

      - name: Pull, Tag and Push
        run: |
          # 1. ç¯å¢ƒæ¸…ç†ä¸å˜é‡é¢„å¤„ç†
          # è‡ªåŠ¨å‰”é™¤å¯èƒ½å­˜åœ¨çš„åè®®å¤´ã€æœ«å°¾æ–œæ å’Œç©ºæ ¼
          REGISTRY=$(echo "${{ secrets.ALIYUN_REGISTRY }}" | sed 's|^https://||;s|/*$||;s| ||g')
          NAMESPACE="clannadxi"
          
          # 2. æ„é€ é•œåƒè·¯å¾„
          SOURCE_IMAGE="${{ github.event.inputs.image_name }}:${{ github.event.inputs.image_tag }}"
          TARGET_IMAGE="$REGISTRY/$NAMESPACE/${{ github.event.inputs.image_name }}:${{ github.event.inputs.image_tag }}"
          
          echo "ğŸš€ å¼€å§‹åŒæ­¥..."
          echo "æºé•œåƒ: $SOURCE_IMAGE"
          echo "ç›®æ ‡è·¯å¾„: $TARGET_IMAGE"
          
          # 3. æ‰§è¡Œ Docker æ“ä½œ
          docker pull $SOURCE_IMAGE
          docker tag $SOURCE_IMAGE $TARGET_IMAGE
          docker push $TARGET_IMAGE
          
          echo "=========================================="
          echo "âœ… åŒæ­¥æˆåŠŸï¼"
          echo "è™šæ‹Ÿæœºæ‹‰å–å‘½ä»¤: docker pull $TARGET_IMAGE"
          echo "=========================================="